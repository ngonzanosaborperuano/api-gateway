# ============================================
# API Gateway - Docker Compose Individual
# ============================================
# Este compose asume que la infraestructura (postgres, redis)
# ya est√° corriendo desde el docker-compose.yml principal
# ============================================

services:
  api-gateway:
    container_name: api-gateway
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "${PORT_API_GATEWAY:-3000}:3000"
    depends_on:
      - express_app
      - nest_app
    command: npm run start:dev
    environment:
      - API_APP=0.0.0.0
      - DEBUG=http-proxy-middleware*
      - NODE_ENV=development
    networks:
      - backend_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Referencias a servicios externos (deben estar corriendo)
  express_app:
    container_name: cocinando_express
    build:
      context: ../bk-express
      dockerfile: Dockerfile
    env_file:
      - ../bk-express/.env
    ports:
      - "${PORT_EXPRESS:-3001}:3001"
    environment:
      - API_APP=0.0.0.0
      - NODE_ENV=development
    networks:
      - backend_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3

  nest_app:
    container_name: cocinando_nest
    build:
      context: ../bk_nest
      dockerfile: Dockerfile
    env_file:
      - ../bk_nest/.env
    ports:
      - "${PORT_NEST:-3002}:3002"
    environment:
      - API_APP=0.0.0.0
      - NODE_ENV=development
    networks:
      - backend_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  backend_net:
    external: true
